# Data Model: Instruction File Sync

**Date**: 2026-01-17

## Entities

### InstructionSource

Represents a file that provides instruction content (template or plain text).

**Fields**:
- `sourcePath`: absolute path to the source file
- `sourceType`: `template` or `repo`
- `isLocal`: boolean (local source precedence)
- `templateMetadata`: optional metadata (targets, outPutPath)
- `resolvedOutputDir`: directory where outputs are written
- `contentHash`: hash of source content (for change detection)

**Validation rules**:
- `/agents/**` templates outside `agents/AGENTS.md` require `outPutPath`.
- `outPutPath` is a directory; any filename segment is stripped.
- Repo `AGENTS.md` outside `/agents` are treated as plain text (no metadata parsing).

### InstructionOutput

Represents a generated target file for a specific output path and target.

**Fields**:
- `outputPath`: absolute path to output file
- `targetType`: `claude`, `gemini`, `codex`, or `copilot`
- `contentHash`: hash of generated output
- `sourcePath`: reference back to the originating InstructionSource
- `status`: `created`, `updated`, `skipped`, `removed`

**Validation rules**:
- Codex/Copilot map to a single `AGENTS.md` per output directory and are counted once.
- Repo sources do not overwrite their own `AGENTS.md` when Codex/Copilot is selected.

### SyncStateRecord

Tracks outputs created by omniagent for safe cleanup and reconciliation.

**Fields**:
- `outputPath`
- `targetType`
- `sourcePath`
- `contentHash`
- `lastSyncedAt`

**Validation rules**:
- Only outputs with matching hashes are eligible for deletion.
- Diverged outputs trigger warnings and are retained in non-interactive mode.

## Relationships

- **InstructionSource 1..*** → **InstructionOutput** (one source can generate multiple outputs)
- **InstructionOutput 1..1** → **SyncStateRecord** (tracked if generated by omniagent)
- **InstructionSource 1..*** → **SyncStateRecord** (via outputs)

## State Transitions

- **Output lifecycle**: `created` → `updated` → `removed` (if source removed and hash matches)
- **Diverged output**: `updated` (by user) → `skipped` deletion with warning
